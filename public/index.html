<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <meta name="Gazal Capital" content="Gazal Capital - The Family Company" />
  <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
  <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
  <!-- <script src="https://apis.google.com/js/platform.js?onload=onLoad"></script> -->
  <title>Gazal Capital</title>
</head>

<body>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <div id="root"></div>
  <script>
    addEventListener('fetch', event => {
      event.respondWith(handleRequest(event.request))
    })

    const createAirtableRecord = body => {
      return fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(AIRTABLE_TABLE_NAME)}`, {
        method: 'POST',
        body: JSON.stringify(body),
        headers: {
          Authorization: `Bearer ${AIRTABLE_API_KEY}`,
          'Content-type': `application/json`
        }
      })
    }

    const submitHandler = async request => {
      if (request.method !== "POST") {
        return new Response("Method Not Allowed", {
          status: 405
        })
      }

      const body = await request.formData();

      const {
        fname,
        lname,
        email,
        phone,
        address,
        message
      } = Object.fromEntries(body)

      const reqBody = {
        fields: {
          "First Name": fname,
          "Last Name": lname,
          "Email": email,
          "Phone Number": phone,
          "Address": address,
          "Message": message
        }
      }

      await createAirtableRecord(reqBody)
      return Response.redirect(FORM_URL)
    }

    async function handleRequest(request) {
      const url = new URL(request.url)

      if (url.pathname === "/submit") {
        return submitHandler(request)
      }

      return new Response.redirect(FORM_URL)
    }
  </script>
</body>

</html>